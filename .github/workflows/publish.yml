name: Publish Images
on: [push]

jobs:
  docker:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v0'
        with:
          workload_identity_provider: 'projects/101730247931/locations/global/workloadIdentityPools/hedera-registry-pool/providers/hedera-registry-gh-actions'
          service_account: 'guardian-publisher@hedera-registry.iam.gserviceaccount.com'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: logger-service
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./logger-service/Dockerfile
          push: true
          tags: logger-service:latest
          registry: gcr.io

      - name: auth-service
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./auth-service/Dockerfile
          push: true
          tags: auth-service:latest

      - name: api-gateway
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./api-gateway/Dockerfile
          push: true
          tags: api-gateway:latest

      - name: guardian-service
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./guardian-service/Dockerfile
          push: true
          tags: guardian-service:latest

      - name: ipfs-client
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./ipfs-client/Dockerfile
          push: true
          tags: ipfs-client:latest

      - name: topic-viewer
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./topic-viewer/Dockerfile
          push: true
          tags: topic-viewer:latest

      - name: api-docs
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./api-docs/Dockerfile
          push: true
          tags: api-docs:latest
